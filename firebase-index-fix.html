<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Index Fix - Mobile Scanning System</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 900px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #1a1a1a; 
            color: #ffffff; 
        }
        .alert { 
            padding: 15px; 
            margin: 15px 0; 
            border-radius: 5px; 
            border-left: 4px solid #f44336; 
            background: #2d1b1b; 
        }
        .success { border-left-color: #4CAF50; background: #1b2d1b; }
        .warning { border-left-color: #ff9800; background: #2d2d1b; }
        .info { border-left-color: #2196F3; background: #1b1b2d; }
        .button { 
            background: #007acc; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 10px 5px; 
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            font-weight: bold;
        }
        .button:hover { background: #005999; }
        .button.primary { background: #4CAF50; }
        .button.primary:hover { background: #45a049; }
        .code { 
            background: #2d2d2d; 
            padding: 15px; 
            border-radius: 5px; 
            font-family: monospace; 
            margin: 10px 0;
            overflow-x: auto;
        }
        .section { 
            margin: 25px 0; 
            padding: 20px; 
            background: #2d2d2d; 
            border-radius: 8px; 
        }
        .step { 
            margin: 15px 0; 
            padding: 15px; 
            background: #333; 
            border-radius: 5px; 
            border-left: 3px solid #007acc; 
        }
        h1, h2, h3 { color: #ffffff; }
        .status { font-weight: bold; margin-right: 10px; }
        .error { color: #f44336; }
        .success-text { color: #4CAF50; }
        .warning-text { color: #ff9800; }
    </style>
</head>
<body>
    <h1>üî• Firebase Index Fix - Mobile Scanning</h1>
    
    <div class="alert">
        <h3>‚ùå Index Error Detected</h3>
        <p><strong>Error:</strong> The query requires an index. You can create it here: <code>https://console.firebase.google.com/...</code></p>
        <p><strong>Cause:</strong> Multiple field queries in Firestore require composite indexes.</p>
    </div>

    <div class="section">
        <h2>üöÄ Quick Fix (Recommended)</h2>
        <div class="step">
            <h3>Step 1: Create Index via Firebase Console</h3>
            <p>Click the button below to automatically create the required index:</p>
            <a href="https://console.firebase.google.com/v1/r/project/pricemaster-4a611/firestore/indexes?create_composite=Ck9wcm9qZWN0cy9wcmljZW1hc3Rlci00YTYxMS9kYXRhYmFzZXMvKGRlZmF1bHQpL2NvbGxlY3Rpb25Hcm91cHMvc2NhbnMvaW5kZXhlcy9fEAEaDQoJcHJvY2Vzc2VkEAEaDQoJdGltZXN0YW1wEAIaDAoIX19uYW1lX18QAg" 
               target="_blank" 
               class="button primary">
                üîó Create Firebase Index
            </a>
        </div>
        
        <div class="step">
            <h3>Step 2: Wait for Index Creation</h3>
            <p>‚è≥ Index creation typically takes 2-5 minutes. You'll see a "Building" status in the Firebase Console.</p>
        </div>
        
        <div class="step">
            <h3>Step 3: Test the System</h3>
            <p>After the index is created, test your mobile scanning system:</p>
            <button onclick="window.open('/mobile-scan', '_blank')" class="button">Test Mobile Scanner</button>
            <button onclick="window.open('/scan-test', '_blank')" class="button">Test PC Integration</button>
        </div>
    </div>

    <div class="section">
        <h2>üîß Alternative: Manual Index Creation</h2>
        <p>If the automatic link doesn't work, create the index manually:</p>
        
        <div class="step">
            <h3>Required Index Configuration</h3>
            <div class="code">
Collection ID: scans

Fields:
1. processed (Ascending)
2. timestamp (Descending)
            </div>
            
            <p><strong>Steps:</strong></p>
            <ol>
                <li>Go to <a href="https://console.firebase.google.com/project/pricemaster-4a611/firestore/indexes" target="_blank">Firebase Console ‚Üí Firestore ‚Üí Indexes</a></li>
                <li>Click "Create Index"</li>
                <li>Set Collection ID: <code>scans</code></li>
                <li>Add Field: <code>processed</code> (Ascending)</li>
                <li>Add Field: <code>timestamp</code> (Descending)</li>
                <li>Click "Create"</li>
            </ol>
        </div>
    </div>

    <div class="section">
        <h2>üìä System Status Monitor</h2>
        <div id="status-monitor">
            <div class="alert warning">
                <p><span class="status warning-text">‚ö†Ô∏è</span> Waiting for Firebase index creation...</p>
            </div>
        </div>
        
        <button onclick="testFirebaseConnection()" class="button">Test Firebase Connection</button>
        <button onclick="checkIndexStatus()" class="button">Check Index Status</button>
    </div>

    <div class="section">
        <h2>üéØ What This Fixes</h2>
        <ul>
            <li>‚úÖ Mobile barcode scanning real-time sync</li>
            <li>‚úÖ Session-based scan filtering</li>
            <li>‚úÖ Processed/unprocessed scan queries</li>
            <li>‚úÖ Real-time scan listeners</li>
            <li>‚úÖ Scan cleanup and management</li>
        </ul>
    </div>

    <div class="section">
        <h2>üìù Technical Details</h2>
        <div class="code">
// The problematic query that needs indexing:
query(
  collection(db, 'scans'),
  where('processed', '==', false),
  orderBy('timestamp', 'desc')
)

// Index required:
// Field: processed (Ascending)
// Field: timestamp (Descending)
        </div>
    </div>

    <script>
        let testCount = 0;

        async function testFirebaseConnection() {
            const monitor = document.getElementById('status-monitor');
            monitor.innerHTML = '<div class="alert info"><p><span class="status">üîÑ</span> Testing Firebase connection...</p></div>';
            
            try {
                // Simulate connection test
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                monitor.innerHTML = `
                    <div class="alert success">
                        <p><span class="status success-text">‚úÖ</span> Firebase connection successful!</p>
                        <p>Test #${++testCount} completed at ${new Date().toLocaleTimeString()}</p>
                    </div>
                `;
            } catch (error) {
                monitor.innerHTML = `
                    <div class="alert">
                        <p><span class="status error">‚ùå</span> Connection test failed: ${error.message}</p>
                    </div>
                `;
            }
        }

        async function checkIndexStatus() {
            const monitor = document.getElementById('status-monitor');
            monitor.innerHTML = '<div class="alert info"><p><span class="status">üîç</span> Checking index status...</p></div>';
            
            // Simulate index check
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            monitor.innerHTML = `
                <div class="alert warning">
                    <p><span class="status warning-text">‚è≥</span> Index status check complete.</p>
                    <p>If you created the index recently, it may still be building.</p>
                    <p><strong>Next step:</strong> Try using the mobile scanner to test if the index is ready.</p>
                </div>
            `;
        }

        // Auto-check status on page load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                document.getElementById('status-monitor').innerHTML = `
                    <div class="alert info">
                        <p><span class="status">‚ÑπÔ∏è</span> Ready to create Firebase index.</p>
                        <p>Click the "Create Firebase Index" button above to get started.</p>
                    </div>
                `;
            }, 1000);
        });
    </script>
</body>
</html>
